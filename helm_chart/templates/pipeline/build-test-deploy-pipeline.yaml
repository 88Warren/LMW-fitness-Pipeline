apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: build-test-deploy-pipeline
  namespace: lmw-fitness
spec:
  description: |
    This pipeline clones a git repo, builds an image with Kaniko and
    pushes it to a registry   
  params:
    - name: GITHUB_CLONE_URL
    - name: IMAGE
    - name: DOCKERFILE
    - name: CONTEXT
    - name: EXTRA_ARGS
    - name: BUILDER_IMAGE
  workspaces:
    - name: git-credentials
    - name: source
    - name: docker-config
  tasks:
    - name: git-clone
      taskRef:
        name: git-clone
        kind: Task
      params:
        - name: GITHUB_CLONE_URL
          value: $(params.GITHUB_CLONE_URL)
        - name: deleteExisting
          value: "true"
      workspaces:
        - name: git-credentials
          workspace: git-credentials
        - name: source
          workspace: source

    - name: kaniko-docker-build
      runAfter: ["git-clone"]
      taskRef:
        name: kaniko-docker-build
        kind: Task
      workspaces:
      - name: source
        workspace: source
      - name: docker-config
        workspace: docker-config
      params:
      - name: IMAGE
        value: $(params.IMAGE)
      - name: DOCKERFILE
        value: $(params.DOCKERFILE)
      - name: CONTEXT
        value: $(params.CONTEXT)
      - name: EXTRA_ARGS
        value: $(params.EXTRA_ARGS)
      - name: BUILDER_IMAGE
        value: $(params.BUILDER_IMAGE)